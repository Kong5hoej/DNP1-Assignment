@page "/posts/{PostId:int}"
@using System.Security.Claims
@using ApiContracts.Comments
@using ApiContracts.Posts
@using ApiContracts.Users
@using BlazorApp.Services
@inject IPostService PostService
@inject IUserService UserService
@inject ICommentService CommentService

@if (post == null)
{
    <p>Loading...</p>
}
else
{
    <h3>@post.Title</h3>
    <p>@post.Body</p>
    <p><strong>User:</strong> @GetUsername(post.UserId)</p>

    <h5>Comments</h5>
    @if (!post.Comments.Any())
    {
        <p>No comments yet.</p>
    }
    else
    {
        <ul>
            @foreach (var comment in comments)
            {
                <li>@comment.Body (User: @GetUsername(comment.UserId))</li>
            }
        </ul>
    }
}

@if (!string.IsNullOrEmpty(UserIds))
{
    <h1>Create New Comment</h1>

    <div class="row mt-3">
        <div class="col-sm-3">
            <input @bind="Body" type="text" placeholder="Body" required>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-sm-3">
            <button @onclick="CreateComment" class="btn btn-primary">Create Comment</button>
        </div>
    </div>
}

@code {
    [Parameter]
    public int PostId { get; set; }
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }

    private GetSinglePostDto? post;
    private List<CommentDto>? comments;
    private Dictionary<int, string> userLookup = new();
    
    protected override async Task OnInitializedAsync()
    {
        post = await PostService.GetSinglePost(PostId);
        
        await LoadComments();
        
        var users = await UserService.GetManyUsers();
        userLookup = users.ToDictionary(u => u.Id, u => u.Username);
        
        AuthenticationState authenticationState = await State;
        ClaimsPrincipal claimsPrincipal = authenticationState.User;
        if(claimsPrincipal.Identity is null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            return;
        }
        string? username = claimsPrincipal.Identity?.Name;
        IEnumerable<Claim> claims = claimsPrincipal.Claims;
        UserIds = claims.Single(c => c.Type == "Id").Value;
    }
    
    private string GetUsername(int userId)
    {
        return userLookup.TryGetValue(userId, out var username) ? username : "Unknown";
    }
    
    public async Task LoadComments()
    {
        comments = await CommentService.GetManyComments(postId: PostId);
    }

    private string Body { get; set; }
    private string UserIds { get; set; }
    public int UserIdi;
    
    public async Task CreateComment()
    {
        int.TryParse(UserIds, out this.UserIdi);

        CreateCommentDto ccd = new CreateCommentDto() { Body = this.Body, UserId = this.UserIdi, PostId = this.PostId };
        await CommentService.AddComment(ccd);
        
        await LoadComments();
        Body = "";
        UserIds = "";
        UserIdi = 0;

        StateHasChanged();
    }
}